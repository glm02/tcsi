<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCSI Planner - Hub √âtudiant</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel pour compiler le JSX √† la vol√©e -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ical.js pour le parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.5.0/ical.min.js"></script>
    
    <!-- FullCalendar (Core + Plugins) -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Configuration Tailwind personnalis√©e -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: {
                            800: '#1e293b', // Bleu Marine TCSI
                            900: '#0f172a',
                        },
                        industrial: {
                            500: '#f97316', // Orange Industriel
                            600: '#ea580c',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; }
        /* Scrollbar clean */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* FullCalendar Customization */
        .fc {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            font-family: 'Inter', sans-serif;
            border: 1px solid #e2e8f0;
        }
        .fc-toolbar-title { font-size: 1.25rem !important; font-weight: 700; color: #1e293b; }
        .fc-button-primary { background-color: #1e293b !important; border-color: #1e293b !important; }
        .fc-button-primary:hover { background-color: #0f172a !important; }
        .fc-button-active { background-color: #f97316 !important; border-color: #f97316 !important; }
        .fc-event { border: none !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .fc-timegrid-slot { height: 3rem !important; } /* Plus d'espace */

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #f97316;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // --- ICONS COMPONENT WRAPPER ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- MOCK DATA / CONSTANTS (POUR LES NOTES & PROJETS SEULEMENT) ---
        const NOTES_DATA = [
            {
                ue: "UE1 : Marketing & Vente BtoB",
                coeff: 4,
                subjects: [
                    { name: "Marketing Industriel", grade: 14, coeff: 2 },
                    { name: "N√©gociation Achat/Vente", grade: 16.5, coeff: 3 },
                    { name: "Relation Client", grade: 12, coeff: 1 }
                ]
            },
            {
                ue: "UE2 : Communication & N√©gociation",
                coeff: 3,
                subjects: [
                    { name: "Anglais Business", grade: 15, coeff: 2 },
                    { name: "Communication Digitale", grade: 13, coeff: 1 },
                    { name: "Droit des Affaires", grade: null, coeff: 1.5 } 
                ]
            },
            {
                ue: "UE3 : Environnement Industriel",
                coeff: 5,
                subjects: [
                    { name: "Logistique & Supply Chain", grade: 11, coeff: 2 },
                    { name: "Technologie Industrielle", grade: 18, coeff: 3 },
                    { name: "Qualit√© & RSE", grade: 14, coeff: 1 }
                ]
            }
        ];

        // --- NOUVEAU HOOK: useAdePlanning (IMPLEMENTATION STRICTE) ---
        const PROXY_URL = "https://api.allorigins.win/get?url=";
        const ADE_URL = "https://edt.univ-lyon1.fr/jsp/custom/modules/plannings/anonymous_cal.jsp?resources=5782&projectId=1&calType=ical&firstDate=2025-08-18&lastDate=2026-08-01";

        const useAdePlanning = () => {
            const [events, setEvents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [retryCount, setRetryCount] = useState(0); // Gard√© pour le bouton refresh

            useEffect(() => {
                const fetchIcs = async () => {
                    setLoading(true);
                    setError(null);
                    try {
                        console.log("Fetching ADE via Proxy...");
                        // 1. On passe par AllOrigins (endpoint /get) pour √©viter l'erreur CORS
                        const response = await fetch(PROXY_URL + encodeURIComponent(ADE_URL));
                        if (!response.ok) throw new Error("Erreur r√©seau proxy");
                        
                        const json = await response.json();
                        // AllOrigins renvoie le contenu du fichier dans .contents
                        const icsData = json.contents; 

                        if (!icsData) throw new Error("Fichier ICS vide ou illisible");

                        // 2. Parsing avec ical.js
                        const jcalData = ICAL.parse(icsData);
                        const comp = new ICAL.Component(jcalData);
                        const vevents = comp.getAllSubcomponents('vevent');

                        // 3. Mapping pour FullCalendar
                        const formattedEvents = vevents.map(vevent => {
                            const event = new ICAL.Event(vevent);
                            const summary = event.summary || "Cours inconnu";
                            
                            // Code couleur simple
                            let color = '#3b82f6'; // Bleu par d√©faut
                            if (summary.includes('TP')) color = '#f97316'; // Orange
                            if (summary.includes('CM')) color = '#1e293b'; // Marine
                            if (summary.includes('Exam') || summary.includes('DS')) color = '#ef4444'; // Rouge

                            return {
                                id: event.uid,
                                title: summary,
                                start: event.startDate.toJSDate(), // Conversion date JS
                                end: event.endDate.toJSDate(),
                                extendedProps: {
                                    location: event.location || "Salle inconnue",
                                    description: event.description,
                                    prof: event.description // Pour compatibilit√© affichage
                                },
                                backgroundColor: color,
                                borderColor: color,
                                textColor: '#ffffff'
                            };
                        });

                        console.log(`${formattedEvents.length} √©v√©nements charg√©s !`);
                        setEvents(formattedEvents);
                    } catch (err) {
                        console.error("Erreur chargement ADE:", err);
                        setError("Impossible de charger le planning (Erreur CORS ou URL)");
                    } finally {
                        setLoading(false);
                    }
                };

                fetchIcs();
            }, [retryCount]);

            const retry = () => setRetryCount(c => c + 1);

            return { events, loading, error, retry };
        };

        // --- COMPONENTS ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden ${className}`}>
                {children}
            </div>
        );

        // --- FULLCALENDAR COMPONENT WRAPPER ---
        const FullCalendarComponent = ({ events }) => {
            const calendarRef = useRef(null);
            const calendarInstance = useRef(null);

            useEffect(() => {
                if (calendarRef.current) {
                    calendarInstance.current = new FullCalendar.Calendar(calendarRef.current, {
                        initialView: window.innerWidth < 768 ? 'timeGridDay' : 'timeGridWeek',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'timeGridWeek,timeGridDay'
                        },
                        events: events,
                        locale: 'fr',
                        firstDay: 1, // Lundi
                        slotMinTime: '08:00:00',
                        slotMaxTime: '20:00:00',
                        allDaySlot: false,
                        weekends: false, // Cache les samedis/dimanches par d√©faut
                        height: 'auto',
                        slotDuration: '00:30:00',
                        nowIndicator: true,
                        buttonText: {
                            today: "Aujourd'hui",
                            month: 'Mois',
                            week: 'Semaine',
                            day: 'Jour'
                        },
                        eventContent: function(arg) {
                            // Custom render for event content
                            return {
                                html: `
                                    <div class="p-1 overflow-hidden">
                                        <div class="font-bold text-xs">${arg.timeText}</div>
                                        <div class="font-bold truncate">${arg.event.title}</div>
                                        ${arg.event.extendedProps.location ? `<div class="text-[10px] opacity-90 truncate">üìç ${arg.event.extendedProps.location}</div>` : ''}
                                    </div>
                                `
                            }
                        }
                    });
                    
                    calendarInstance.current.render();
                }

                return () => {
                    if (calendarInstance.current) {
                        calendarInstance.current.destroy();
                    }
                };
            }, []);

            // Update events when prop changes
            useEffect(() => {
                if (calendarInstance.current) {
                    // Remove all events and add new ones
                    calendarInstance.current.removeAllEvents();
                    calendarInstance.current.addEventSource(events);
                }
            }, [events]);

            return <div ref={calendarRef} className="animate-fade-in" />;
        };

        // --- FEATURE: CALENDAR VIEW ---
        const CalendarView = ({ events, loading, error, retry }) => {
            if (loading) return (
                <div className="flex flex-col items-center justify-center p-12 h-96">
                    <div className="loading-spinner mb-4"></div>
                    <p className="text-slate-500 animate-pulse">R√©cup√©ration du planning ADE...</p>
                </div>
            );

            if (error) return (
                <div className="flex flex-col items-center justify-center p-8 text-center bg-red-50 border border-red-200 rounded-xl h-96">
                    <div className="text-red-500 mb-2"><Icon name="wifi-off" size={48} /></div>
                    <h3 className="text-lg font-bold text-red-700 mb-2">Erreur de connexion</h3>
                    <p className="text-red-600 mb-4 max-w-md">{error}</p>
                    <button onClick={retry} className="px-4 py-2 bg-navy-800 text-white rounded-lg hover:bg-navy-900 transition-colors flex items-center gap-2">
                        <Icon name="refresh-cw" size={16} /> R√©essayer
                    </button>
                </div>
            );

            return (
                <div className="space-y-4">
                    <header className="flex justify-between items-center mb-2">
                         <div>
                            <h2 className="text-2xl font-bold text-navy-800">Mon Emploi du Temps</h2>
                            <p className="text-slate-500 text-sm">Synchronis√© avec ADE Lyon 1 (R√©el)</p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={retry} className="p-2 text-slate-500 hover:bg-slate-100 rounded-full" title="Forcer la synchro">
                                <Icon name="refresh-cw" size={18} />
                            </button>
                        </div>
                    </header>
                    
                    <FullCalendarComponent events={events} />
                    
                    <div className="flex gap-4 mt-4 text-sm justify-center md:justify-start flex-wrap">
                        <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-navy-800"></div> CM (Cours)</div>
                        <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-blue-500"></div> Autre</div>
                        <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-industrial-500"></div> TP (Pratiques)</div>
                         <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-red-500"></div> Exam/DS</div>
                    </div>
                </div>
            );
        };

        // --- FEATURE: GRADES (UNCHANGED) ---
        const GradesView = () => {
            const globalStats = useMemo(() => {
                let totalPoints = 0, totalCoeff = 0;
                NOTES_DATA.forEach(ue => {
                    ue.subjects.forEach(sub => {
                        if (sub.grade !== null) {
                            totalPoints += sub.grade * sub.coeff;
                            totalCoeff += sub.coeff;
                        }
                    });
                });
                return totalCoeff > 0 ? (totalPoints / totalCoeff).toFixed(2) : "N/A";
            }, []);

            return (
                <div className="space-y-6">
                    <header className="flex justify-between items-end">
                        <div>
                            <h2 className="text-2xl font-bold text-navy-800">Mes R√©sultats</h2>
                            <p className="text-slate-500">Suivi des notes BUT TCSI</p>
                        </div>
                        <div className="text-right">
                            <span className="text-sm text-slate-500 uppercase font-semibold">Moyenne G√©n√©rale</span>
                            <div className="text-3xl font-bold text-industrial-500">{globalStats} / 20</div>
                        </div>
                    </header>
                    <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                        {NOTES_DATA.map((ue, idx) => {
                            let uePoints = 0, ueCoeff = 0;
                            ue.subjects.forEach(s => {
                                if(s.grade !== null) { uePoints += s.grade * s.coeff; ueCoeff += s.coeff; }
                            });
                            const ueAvg = ueCoeff > 0 ? (uePoints / ueCoeff).toFixed(2) : "N/A";
                            return (
                                <Card key={idx} className="flex flex-col">
                                    <div className="p-4 bg-navy-800 text-white">
                                        <div className="flex justify-between items-start">
                                            <h3 className="font-bold text-sm opacity-90">{ue.ue}</h3>
                                            <span className="bg-white/20 px-2 py-0.5 rounded text-xs">Coef {ue.coeff}</span>
                                        </div>
                                        <div className="mt-2 text-2xl font-bold">{ueAvg}</div>
                                    </div>
                                    <div className="p-4 space-y-3 flex-1">
                                        {ue.subjects.map((sub, sIdx) => (
                                            <div key={sIdx} className="flex justify-between items-center text-sm border-b border-slate-100 last:border-0 pb-2 last:pb-0">
                                                <div className="flex-1">
                                                    <div className="font-medium text-slate-700">{sub.name}</div>
                                                    <div className="text-xs text-slate-400">Coef {sub.coeff}</div>
                                                </div>
                                                <div className={`font-bold ${sub.grade >= 10 ? 'text-emerald-600' : sub.grade === null ? 'text-slate-300' : 'text-red-500'}`}>
                                                    {sub.grade !== null ? sub.grade : '-'}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </Card>
                            )
                        })}
                    </div>
                </div>
            );
        };

        // --- FEATURE: PROJECTS (KANBAN) (UNCHANGED) ---
        const ProjectsView = () => {
            const [projects, setProjects] = useState([
                { id: 1, title: "SA√â 2.1 - √âtude march√© Pompe √† Chaleur", status: "DOING", due: "15/03", members: ["Toi", "L√©a", "Marc"] },
                { id: 2, title: "SA√â 1.2 - Vente simul√©e (Sketch)", status: "TODO", due: "20/03", members: ["Toi", "Thomas"] },
                { id: 3, title: "Dossier Droit des contrats", status: "DONE", due: "10/02", members: ["Indiv."] },
            ]);
            const moveProject = (id, newStatus) => {
                setProjects(projects.map(p => p.id === id ? { ...p, status: newStatus } : p));
            };
            const columns = [
                { id: 'TODO', label: '√Ä faire', color: 'bg-slate-200' },
                { id: 'DOING', label: 'En cours', color: 'bg-industrial-500/10 text-industrial-600' },
                { id: 'DONE', label: 'Termin√©', color: 'bg-emerald-500/10 text-emerald-600' }
            ];
            return (
                <div className="h-[calc(100vh-140px)] flex flex-col">
                    <header className="mb-6">
                        <h2 className="text-2xl font-bold text-navy-800">Projets SA√â</h2>
                        <p className="text-slate-500">Gestion de projet agile</p>
                    </header>
                    <div className="flex-1 overflow-x-auto">
                        <div className="flex gap-4 min-w-[800px] h-full">
                            {columns.map(col => (
                                <div key={col.id} className="flex-1 bg-slate-50/50 rounded-xl border border-slate-200 flex flex-col max-h-full">
                                    <div className={`p-3 font-bold border-b border-slate-100 flex justify-between items-center ${col.color.includes('bg-slate') ? 'text-slate-600' : ''} ${col.id === 'DOING' ? 'text-industrial-600' : ''} ${col.id === 'DONE' ? 'text-emerald-600' : ''}`}>
                                        {col.label}
                                        <span className="bg-white px-2 py-0.5 rounded-full text-xs shadow-sm text-black">{projects.filter(p => p.status === col.id).length}</span>
                                    </div>
                                    <div className="p-3 space-y-3 overflow-y-auto flex-1">
                                        {projects.filter(p => p.status === col.id).map(p => (
                                            <Card key={p.id} className="p-3 hover:shadow-md cursor-pointer transition-all border-l-4 border-l-transparent hover:border-l-industrial-500">
                                                <div className="flex justify-between items-start mb-2">
                                                    <span className="text-xs font-semibold bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">J-{p.due.split('/')[0]}</span>
                                                    <div className="flex gap-1">
                                                        {col.id !== 'TODO' && <button onClick={() => moveProject(p.id, col.id === 'DONE' ? 'DOING' : 'TODO')} className="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-navy-800"><Icon name="arrow-left" size={14}/></button>}
                                                        {col.id !== 'DONE' && <button onClick={() => moveProject(p.id, col.id === 'TODO' ? 'DOING' : 'DONE')} className="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-navy-800"><Icon name="arrow-right" size={14}/></button>}
                                                    </div>
                                                </div>
                                                <h4 className="font-bold text-slate-800 text-sm mb-3">{p.title}</h4>
                                                <div className="flex items-center justify-between text-xs text-slate-500">
                                                    <div className="flex -space-x-2">
                                                        {p.members.map((m, i) => <div key={i} className="w-6 h-6 rounded-full bg-navy-800 text-white flex items-center justify-center border border-white text-[10px]" title={m}>{m.charAt(0)}</div>)}
                                                    </div>
                                                    <div className="flex items-center gap-1"><Icon name="calendar" size={12} /> {p.due}</div>
                                                </div>
                                            </Card>
                                        ))}
                                        <button className="w-full py-2 border border-dashed border-slate-300 rounded-lg text-slate-400 text-sm hover:border-industrial-500 hover:text-industrial-500 transition-colors flex items-center justify-center gap-2">
                                            <Icon name="plus" size={16} /> Ajouter une t√¢che
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )
        }

        // --- MAIN APP ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('agenda');
            // Utilisation du nouveau hook useAdePlanning
            const { events, loading, error, retry } = useAdePlanning();

            const navItems = [
                { id: 'agenda', label: 'Mon Agenda', icon: 'calendar' },
                { id: 'grades', label: 'Mes Notes', icon: 'bar-chart-2' },
                { id: 'projects', label: 'Projets SA√â', icon: 'trello' },
                { id: 'profile', label: 'Profil', icon: 'user' },
            ];

            const renderContent = () => {
                switch(activeTab) {
                    case 'agenda': return <CalendarView events={events} loading={loading} error={error} retry={retry} />;
                    case 'grades': return <GradesView />;
                    case 'projects': return <ProjectsView />;
                    default: return <div className="p-8 text-center text-slate-500">Section en construction</div>;
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 font-sans flex flex-col md:flex-row">
                    {/* Mobile Header */}
                    <div className="md:hidden bg-navy-800 text-white p-4 flex justify-between items-center sticky top-0 z-50 shadow-md">
                        <div className="font-bold text-xl flex items-center gap-2"><span className="text-industrial-500"><Icon name="hexagon" /></span> TCSI Planner</div>
                        <button className="p-2"><Icon name="bell" /></button>
                    </div>

                    {/* Desktop Sidebar */}
                    <aside className="hidden md:flex flex-col w-64 bg-navy-800 text-white h-screen sticky top-0 shadow-xl">
                        <div className="p-6">
                            <h1 className="text-2xl font-bold flex items-center gap-2"><span className="text-industrial-500"><Icon name="hexagon" className="fill-current" /></span> TCSI Planner</h1>
                            <p className="text-xs text-slate-400 mt-1">Assistant Syst√®mes Industriels</p>
                        </div>
                        <nav className="flex-1 px-4 py-6 space-y-2">
                            {navItems.map(item => (
                                <button key={item.id} onClick={() => setActiveTab(item.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeTab === item.id ? 'bg-industrial-500 text-white shadow-lg shadow-industrial-500/30' : 'text-slate-300 hover:bg-white/10 hover:text-white'}`}>
                                    <Icon name={item.icon} size={20} /> <span className="font-medium">{item.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 mt-auto">
                            <div className="bg-navy-900 rounded-xl p-4 flex items-center gap-3 border border-white/10">
                                <div className="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-navy-900 font-bold">ET</div>
                                <div><div className="text-sm font-bold">√âtudiante TCSI</div><div className="text-xs text-slate-400">Lyon 1 - Semestre 2</div></div>
                            </div>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 p-4 md:p-8 overflow-y-auto h-[calc(100vh-60px)] md:h-screen">
                        <div className="max-w-7xl mx-auto">{renderContent()}</div>
                    </main>

                    {/* Mobile Bottom Nav */}
                    <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around p-3 pb-safe z-50">
                        {navItems.map(item => (
                            <button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex flex-col items-center gap-1 ${activeTab === item.id ? 'text-industrial-600' : 'text-slate-400'}`}>
                                <Icon name={item.icon} size={24} /><span className="text-[10px] font-medium">{item.label}</span>
                            </button>
                        ))}
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
